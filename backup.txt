# app.py

import streamlit as st
import pandas as pd
import numpy as np
import pickle
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px

# Page configuration
st.set_page_config(page_title="Health Prediction System", page_icon="ğŸ©º", layout="centered")

# Load models
diabetes_model = pickle.load(open("model/diabetes_model.pkl", "rb"))
anemia_model = pickle.load(open("model/anemia_model.pkl", "rb"))

# App title
st.title("ğŸ©º Health Prediction and Report Analyzer")
st.markdown("### Predict Diseases & Analyze Health Reports with AI ğŸ§ ")
st.divider()

# Sidebar for model selection
model_choice = st.sidebar.selectbox("Choose Prediction Model", ["--Select--", "ğŸ¬ Diabetes Prediction", "ğŸ©¸ Anemia Prediction"])

# Function to show chart inline
def show_plot(fig):
    st.pyplot(fig)

# =============================
# ğŸ¬ Diabetes Prediction Section
# =============================
if model_choice == "ğŸ¬ Diabetes Prediction":
    st.subheader("Diabetes Prediction Model")
    st.info("Enter your health parameters below or upload a report CSV file.")

    upload_option = st.radio("Select input method:", ["Manual Input", "Upload CSV"])
        # =====================================
    # ğŸ§® Manual Input Section
    # =====================================
    if upload_option == "Manual Input":
        HbA1C = st.number_input("HbA1C (%)", 0.0)
        glucose = st.number_input("Estimated Average Glucose (mg/dL)", 0.0)
        cholesterol = st.number_input("Cholesterol (mg/dL)", 0.0)
        triglycerides = st.number_input("Triglycerides (mg/dL)", 0.0)
        bp_sys = st.number_input("Blood Pressure (Systolic mmHg)", 0.0)
        bp_dia = st.number_input("Blood Pressure (Diastolic mmHg)", 0.0)

        if st.button("Predict Diabetes"):
            input_data = np.array([[HbA1C, glucose, cholesterol, triglycerides, bp_sys, bp_dia]])
            prediction = diabetes_model.predict(input_data)[0]

            # --- Risk Assessment ---
            risk = "Low"
            doctor_consultancy = 30
            if HbA1C > 6.5 or glucose > 140 or cholesterol > 200:
                risk = "High"
                doctor_consultancy = 90
            elif 5.7 <= HbA1C <= 6.5:
                risk = "Moderate"
                doctor_consultancy = 70

            # --- Detailed AI Report Summary ---
            st.markdown("## ğŸ§  **AI Health Report Summary**")
            if prediction == 1:
                st.error("âš ï¸ High Risk of Diabetes Detected!")
                st.write(
                    "- Your blood glucose and HbA1C levels indicate poor sugar control.\n"
                    "- Thereâ€™s a significant risk of type 2 diabetes development.\n"
                    "- Elevated cholesterol or blood pressure adds cardiovascular strain.\n"
                    "- Medical intervention and diet changes are urgently required.\n"
                    "- Please consult your doctor for treatment and continuous monitoring."
                )
            elif risk == "Moderate":
                st.warning("ğŸŸ  Moderate Risk â€” Prediabetic Indicators Found.")
                st.write(
                    "- Your glucose and HbA1C levels are slightly above the healthy range.\n"
                    "- You may be in a prediabetic stage if not managed proactively.\n"
                    "- Cholesterol and BP levels are borderline high, needing lifestyle control.\n"
                    "- Early prevention can completely reverse this trend.\n"
                    "- Focus on regular exercise and balanced nutrition."
                )
            else:
                st.success("âœ… No Diabetes Detected â€” Youâ€™re in a Healthy Range!")
                st.write(
                    "- All parameters are within normal healthy limits.\n"
                    "- Excellent sugar and cholesterol management observed.\n"
                    "- No signs of diabetes or cardiovascular stress.\n"
                    "- Maintain current lifestyle and keep regular yearly checkups.\n"
                    "- Focus on fitness, hydration, and mental health."
                )

            # --- Doctor Consultancy Progress Bar ---
            st.markdown("### ğŸ¥ **Doctor Consultancy Recommendation Level**")
            progress_html = f"""
            <div style='width: 100%; background-color: #e0e0e0; border-radius: 20px; height: 25px;'>
                <div style='width: {doctor_consultancy}%; background-color: #007bff;
                            height: 25px; border-radius: 20px; text-align: center;
                            color: white; font-weight: bold; line-height: 25px;'>
                    {doctor_consultancy}%
                </div>
            </div>
            """
            st.markdown(progress_html, unsafe_allow_html=True)

            # --- Lifestyle & Diet Recommendations ---
            st.markdown("### ğŸ¥— **Lifestyle & Diet Recommendations**")
            if risk == "High":
                st.markdown("""
                - ğŸš« **Avoid:** sugary drinks, desserts, alcohol, and fried meals.  
                - âœ… **Eat:** fiber-rich foods (oats, lentils, green veggies, apples, guava).  
                - ğŸƒ **Exercise:** 30â€“45 mins/day (walking, yoga, cycling).  
                - ğŸ’§ **Hydrate:** drink 3L of water/day, sleep 7â€“8 hours.  
                - ğŸ©º **Consult:** doctor immediately for diabetes management plan.  
                """)
            elif risk == "Moderate":
                st.markdown("""
                - âš–ï¸ **Limit:** sugar, refined carbs, and late-night meals.  
                - ğŸ½ **Add:** proteins (paneer, tofu, eggs, legumes).  
                - ğŸ§˜ **Stay Active:** 5 days/week physical activity.  
                - ğŸ’§ **Hydrate:** 2â€“3L water daily.  
                - ğŸ©º **Consult:** doctor once every 3â€“4 months.  
                """)
            else:
                st.markdown("""
                - ğŸ¥¦ **Maintain:** balanced diet (whole grains, protein, fruits).  
                - ğŸš¶ **Activity:** 30 mins daily exercise.  
                - ğŸŒ™ **Sleep:** 7â€“8 hrs per night.  
                - ğŸ’§ **Hydrate:** 2.5L water/day.  
                - ğŸ©º **Consult:** once a year for general checkup.  
                """)

            # --- Graphical Comparison ---
            normal_values = {
                "HbA1C": 5.6,
                "EstimatedAverageGlucose": 126,
                "Cholesterol": 200,
                "Triglycerides": 150,
                "BloodPressureSys": 120,
                "BloodPressureDia": 80,
            }

            values = [HbA1C, glucose, cholesterol, triglycerides, bp_sys, bp_dia]
            compare_df = pd.DataFrame({
                "Parameter": list(normal_values.keys()),
                "Your Value": values,
                "Normal Max": list(normal_values.values())
            })

            fig = px.bar(compare_df, x="Parameter", y=["Your Value", "Normal Max"],
                         barmode="group", color_discrete_sequence=["#ff6666", "#66ccff"],
                         title="ğŸ“Š Your Report vs Healthy Range")
            st.plotly_chart(fig)

            st.success("âœ… Full AI Report with Lifestyle & Consultancy Insights Generated Successfully!")

    # =====================================
    # ğŸ“ CSV Upload Section
    # =====================================
    elif upload_option == "Upload CSV":
        uploaded_file = st.file_uploader("Upload your report CSV", type=["csv"])

        if uploaded_file is not None:
            try:
                df = pd.read_csv(uploaded_file)
                st.write("ğŸ“„ Uploaded Report Preview:")
                st.dataframe(df)

                required_cols = ["HbA1C", "EstimatedAverageGlucose", "Cholesterol",
                                 "Triglycerides", "BloodPressureSys", "BloodPressureDia"]

                if not all(col in df.columns for col in required_cols):
                    st.error("âš ï¸ Uploaded file format incorrect. Columns needed:")
                    st.write(required_cols)
                else:
                    if "Label" in df.columns:
                        input_df = df.drop("Label", axis=1)
                    else:
                        input_df = df.copy()

                    predictions = diabetes_model.predict(input_df)
                    df["Prediction"] = predictions
                    st.success("âœ… Predictions Generated Successfully!")

                    # Patient-wise summaries
                    for i, row in df.iterrows():
                        st.markdown(f"## ğŸ§¬ Patient {i+1} Report")
                        risk = "Low"
                        if row["HbA1C"] > 6.5 or row["EstimatedAverageGlucose"] > 140 or row["Cholesterol"] > 200:
                            risk = "High"
                        elif 5.7 <= row["HbA1C"] <= 6.5:
                            risk = "Moderate"

                        if row["Prediction"] == 1:
                            st.error("âš ï¸ High Risk of Diabetes Detected!")
                        elif risk == "Moderate":
                            st.warning("ğŸŸ  Moderate Risk â€” Possible Prediabetes.")
                        else:
                            st.success("âœ… No Diabetes Detected!")

                        st.write(
                            f"- **Risk Level:** {risk}\n"
                            f"- **HbA1C:** {row['HbA1C']} | **Glucose:** {row['EstimatedAverageGlucose']} mg/dL\n"
                            f"- **Cholesterol:** {row['Cholesterol']} | **BP:** {row['BloodPressureSys']}/{row['BloodPressureDia']} mmHg\n"
                        )

                    # Average value comparison
                    st.subheader("ğŸ“‰ Parameter Comparison (Average Values)")
                    avg_values = df[required_cols].mean()
                    compare_df = pd.DataFrame({
                        "Parameter": required_cols,
                        "Your Avg Value": avg_values.values,
                        "Normal Max": [5.6, 126, 200, 150, 120, 80]
                    })
                    fig = px.bar(compare_df, x="Parameter", y=["Your Avg Value", "Normal Max"],
                                 barmode="group", color_discrete_sequence=["#ff6666", "#66ccff"],
                                 title="Average Report vs Normal Range")
                    st.plotly_chart(fig)

                    st.info("ğŸ©º Full Report Generated with Summary and Recommendations.")

                    # ==========================================
                    # ğŸ§  ENHANCED AI HEALTH REPORT SUMMARY
                    # ==========================================
                    st.markdown("## ğŸ§  **AI Health Report Summary (Based on Average Values)**")

                    HbA1C = avg_values["HbA1C"]
                    glucose = avg_values["EstimatedAverageGlucose"]
                    cholesterol = avg_values["Cholesterol"]

                    risk = "Low"
                    doctor_consultancy = 30  # Default percentage

                    if HbA1C > 6.5 or glucose > 140 or cholesterol > 200:
                        risk = "High"
                        doctor_consultancy = 90
                    elif 5.7 <= HbA1C <= 6.5:
                        risk = "Moderate"
                        doctor_consultancy = 70

                    # ğŸ§  Risk Summary
                    if risk == "High":
                        st.error("âš ï¸ High Risk of Diabetes Detected!")
                        st.write(
                            "- Blood glucose and HbA1C levels indicate poor sugar control.\n"
                            "- Type 2 diabetes risk is **very high** â€” immediate medical attention recommended.\n"
                            "- High cholesterol or BP adds cardiac risk.\n"
                            "- Doctor consultation is **strongly advised.**"
                        )
                    elif risk == "Moderate":
                        st.warning("ğŸŸ  Moderate Risk â€” Prediabetic Indicators Found.")
                        st.write(
                            "- Slightly elevated glucose or HbA1C indicates prediabetic stage.\n"
                            "- Lifestyle changes and early monitoring can **prevent progression.**\n"
                            "- Doctor consultation **recommended within a few months.**"
                        )
                    else:
                        st.success("âœ… Low Risk â€” No Diabetes Detected!")
                        st.write(
                            "- All parameters are in a healthy range.\n"
                            "- Maintain your current healthy lifestyle.\n"
                            "- Routine annual check-ups are sufficient."
                        )

                    # ğŸ¥ Doctor Consultancy Progress Bar
                    st.markdown("### ğŸ¥ **Doctor Consultancy Recommendation Level**")
                    progress_html = f"""
                    <div style='width: 100%; background-color: #e0e0e0; border-radius: 20px; height: 25px;'>
                        <div style='width: {doctor_consultancy}%; background-color: #007bff;
                                    height: 25px; border-radius: 20px; text-align: center;
                                    color: white; font-weight: bold; line-height: 25px;'>
                            {doctor_consultancy}%
                        </div>
                    </div>
                    """
                    st.markdown(progress_html, unsafe_allow_html=True)

                    # ğŸ¥— Lifestyle Recommendations
                    st.markdown("### ğŸ¥— **Lifestyle & Diet Recommendations**")

                    if risk == "High":
                        st.markdown("""
                        - ğŸš« **Avoid:** sugary foods, desserts, alcohol, and fried meals.  
                        - âœ… **Eat:** fiber-rich foods (oats, lentils, green veggies, apples, guava).  
                        - ğŸƒ **Exercise:** 30â€“45 mins/day (walking, yoga, cycling).  
                        - ğŸ’§ **Hydrate:** drink 3L of water/day, sleep 7â€“8 hours.  
                        - ğŸ©º **Consult:** doctor immediately for diabetes management plan.  
                        """)
                    elif risk == "Moderate":
                        st.markdown("""
                        - âš–ï¸ **Limit:** sugar, refined carbs, and late-night meals.  
                        - ğŸ½ **Add:** proteins (paneer, tofu, eggs, legumes).  
                        - ğŸ§˜ **Stay Active:** 5 days/week physical activity.  
                        - ğŸ’§ **Hydrate:** 2â€“3L water daily.  
                        - ğŸ©º **Consult:** doctor once every 3â€“4 months.  
                        """)
                    else:
                        st.markdown("""
                        - ğŸ¥¦ **Maintain:** balanced diet (whole grains, protein, fruits).  
                        - ğŸš¶ **Activity:** 30 mins daily exercise.  
                        - ğŸŒ™ **Sleep:** 7â€“8 hrs per night.  
                        - ğŸ’§ **Hydrate:** 2.5L water/day.  
                        - ğŸ©º **Consult:** once a year for general checkup.  
                        """)

                    st.success("âœ… Full AI Report with Lifestyle & Consultancy Insights Generated Successfully!")

            except Exception as e:
                st.error(f"âš ï¸ Error while processing file: {e}")



# =============================
# ğŸ©¸ Anemia Prediction Section (Enhanced)
# =============================
elif model_choice == "ğŸ©¸ Anemia Prediction":
    st.subheader("ğŸ©¸ Anemia Prediction Model")
    st.info("Enter your blood parameters manually or upload a lab report (CSV). The AI will assess your anemia risk and provide health insights, recommendations, and doctor consultation guidance.")

    upload_option = st.radio("Select input method:", ["Manual Input", "Upload CSV"], horizontal=True)

        # =====================================
    # ğŸ§® Manual Input Section
    # =====================================
    if upload_option == "Manual Input":
        gender = st.selectbox("Gender", ["Male", "Female"])
        gender_val = 0 if gender == "Male" else 1
        hemoglobin = st.number_input("Hemoglobin (g/dL)", 0.0)
        mch = st.number_input("Mean Corpuscular Hemoglobin (MCH)", 0.0)
        mchc = st.number_input("Mean Corpuscular Hemoglobin Concentration (MCHC)", 0.0)
        mcv = st.number_input("Mean Corpuscular Volume (MCV)", 0.0)

        if st.button("ğŸ” Analyze Report"):
            # Make input dataframe
            input_data = np.array([[gender_val, hemoglobin, mch, mchc, mcv]])
            prediction = anemia_model.predict(input_data)[0]

            # --- Simulate single-patient dataframe for uniformity ---
            df = pd.DataFrame([{
                "Gender": gender_val,
                "Hemoglobin": hemoglobin,
                "MCH": mch,
                "MCHC": mchc,
                "MCV": mcv,
                "Prediction": prediction
            }])

            # --- Detailed per-patient summary (same as CSV logic) ---
            for i, row in df.iterrows():
                st.markdown(f"## ğŸ§¬ Patient {i+1} Report")
                risk = "Low"
                if row["Hemoglobin"] < 11 or row["MCH"] < 27 or row["MCHC"] < 31 or row["MCV"] < 80:
                    risk = "High"
                elif 11 <= row["Hemoglobin"] <= 12:
                    risk = "Moderate"

                # --- AI Health Report Summary ---
                st.markdown("## ğŸ§  **AI Health Report Summary**")
                if row["Prediction"] == 1 or risk == "High":
                    st.error("âš ï¸ High Risk of Anemia Detected!")
                    summary = (
                        "- Your blood results suggest iron deficiency anemia.\n"
                        "- Low hemoglobin and MCV indicate smaller red blood cells.\n"
                        "- Reduced MCHC means less hemoglobin per cell.\n"
                        "- Immediate consultation with a physician is advised.\n"
                        "- Iron supplementation and diet modification are crucial."
                    )
                    doctor_level = 90
                elif risk == "Moderate":
                    st.warning("ğŸŸ  Moderate Risk of Anemia.")
                    summary = (
                        "- Your hemoglobin and red cell indices are slightly below normal.\n"
                        "- Early-stage anemia or poor nutrition might be present.\n"
                        "- Monitor iron levels and include nutrient-rich foods.\n"
                        "- Consider a follow-up blood test in 1 month."
                    )
                    doctor_level = 65
                else:
                    st.success("âœ… No Anemia Detected â€” Youâ€™re in a Healthy Range!")
                    summary = (
                        "- All red blood cell parameters are within normal range.\n"
                        "- No signs of anemia or iron deficiency.\n"
                        "- Maintain a healthy, iron-rich diet and regular hydration.\n"
                        "- Keep monitoring with yearly checkups."
                    )
                    doctor_level = 25

                st.write(summary)

                # --- Doctor Consultation Progress Bar ---
                st.markdown("### ğŸ©º Doctor Consultation Urgency")
                st.progress(doctor_level / 100)
                st.write(f"**Consultation Priority:** {doctor_level}%")

                # --- Lifestyle & Diet Recommendations ---
                st.markdown("### ğŸ¥— **Lifestyle & Diet Recommendations**")
                if risk == "High":
                    st.write(
                        "- Include iron-rich foods: spinach, red meat, lentils, beets.\n"
                        "- Add Vitamin C sources (orange, amla) to enhance absorption.\n"
                        "- Avoid tea/coffee near meals (blocks iron uptake).\n"
                        "- Ensure 8 hours of sleep daily and regular meals.\n"
                        "- Doctor may prescribe iron or folate supplements."
                    )
                elif risk == "Moderate":
                    st.write(
                        "- Eat eggs, legumes, tofu, and dark green vegetables.\n"
                        "- Increase iron intake with fish and nuts.\n"
                        "- Stay hydrated and reduce stress.\n"
                        "- Perform light exercise daily to improve blood oxygenation."
                    )
                else:
                    st.write(
                        "- Maintain a balanced iron intake through natural foods.\n"
                        "- Continue including leafy greens, fruits, and cereals.\n"
                        "- Avoid skipping meals.\n"
                        "- Annual CBC test recommended for general wellness."
                    )

                # --- Visualization: Comparison vs Healthy Range ---
                normal_values = {
                    "Hemoglobin": 13.5 if gender == "Male" else 12.0,
                    "MCH": 29,
                    "MCHC": 33,
                    "MCV": 90
                }

                compare_df = pd.DataFrame({
                    "Parameter": list(normal_values.keys()),
                    "Your Value": [row["Hemoglobin"], row["MCH"], row["MCHC"], row["MCV"]],
                    "Healthy Range": list(normal_values.values())
                })

                fig = px.bar(compare_df, x="Parameter", y=["Your Value", "Healthy Range"],
                             barmode="group", color_discrete_sequence=["#ff6666", "#66ccff"],
                             title="ğŸ“Š Your Report vs Healthy Range")
                st.plotly_chart(fig)

        # =====================================
    # ğŸ“ CSV Upload Section
    # =====================================
    else:
        uploaded_file = st.file_uploader("ğŸ“‚ Upload your Anemia Report (CSV)", type=["csv"])
        if uploaded_file is not None:
            df = pd.read_csv(uploaded_file)
            st.write("ğŸ“„ Uploaded Report Preview:")
            st.dataframe(df.head())

            # Drop "Result" only if present
            if "Result" in df.columns:
                input_df = df.drop("Result", axis=1)
            else:
                input_df = df.copy()

            # Convert Gender to numeric if present
            if "Gender" in input_df.columns:
                input_df["Gender"] = input_df["Gender"].replace({"Male": 0, "Female": 1})

            # Convert everything to numeric safely
            input_df = input_df.apply(pd.to_numeric, errors="coerce").fillna(0)

            # Predict safely
            predictions = anemia_model.predict(input_df)
            df["Prediction"] = predictions
            st.success("âœ… Predictions generated successfully!")

            # --- Detailed per-patient summary ---
            for i, row in df.iterrows():
                st.markdown(f"## ğŸ§¬ Patient {i+1} Report")
                risk = "Low"
                if row["Hemoglobin"] < 11 or row["MCH"] < 27 or row["MCHC"] < 31 or row["MCV"] < 80:
                    risk = "High"
                elif 11 <= row["Hemoglobin"] <= 12:
                    risk = "Moderate"

                # --- AI Health Report Summary ---
                st.markdown("## ğŸ§  **AI Health Report Summary**")
                if row["Prediction"] == 1 or risk == "High":
                    st.error("âš ï¸ High Risk of Anemia Detected!")
                    summary = (
                        "- Your blood results suggest iron deficiency anemia.\n"
                        "- Low hemoglobin and MCV indicate smaller red blood cells.\n"
                        "- Reduced MCHC means less hemoglobin per cell.\n"
                        "- Immediate consultation with a physician is advised.\n"
                        "- Iron supplementation and diet modification are crucial."
                    )
                    doctor_level = 90
                elif risk == "Moderate":
                    st.warning("ğŸŸ  Moderate Risk of Anemia.")
                    summary = (
                        "- Your hemoglobin and red cell indices are slightly below normal.\n"
                        "- Early-stage anemia or poor nutrition might be present.\n"
                        "- Monitor iron levels and include nutrient-rich foods.\n"
                        "- Consider a follow-up blood test in 1 month."
                    )
                    doctor_level = 65
                else:
                    st.success("âœ… No Anemia Detected â€” Youâ€™re in a Healthy Range!")
                    summary = (
                        "- All red blood cell parameters are within normal range.\n"
                        "- No signs of anemia or iron deficiency.\n"
                        "- Maintain a healthy, iron-rich diet and regular hydration.\n"
                        "- Keep monitoring with yearly checkups."
                    )
                    doctor_level = 25

                st.write(summary)

                # --- Doctor Consultation Progress Bar ---
                st.markdown("### ğŸ©º Doctor Consultation Urgency")
                st.progress(doctor_level / 100)
                st.write(f"**Consultation Priority:** {doctor_level}%")

                # --- Lifestyle & Diet Recommendations ---
                st.markdown("### ğŸ¥— **Lifestyle & Diet Recommendations**")
                if risk == "High":
                    st.write(
                        "- Include iron-rich foods: spinach, red meat, lentils, beets.\n"
                        "- Add Vitamin C sources (orange, amla) to enhance absorption.\n"
                        "- Avoid tea/coffee near meals (blocks iron uptake).\n"
                        "- Ensure 8 hours of sleep daily and regular meals.\n"
                        "- Doctor may prescribe iron or folate supplements."
                    )
                elif risk == "Moderate":
                    st.write(
                        "- Eat eggs, legumes, tofu, and dark green vegetables.\n"
                        "- Increase iron intake with fish and nuts.\n"
                        "- Stay hydrated and reduce stress.\n"
                        "- Perform light exercise daily to improve blood oxygenation."
                    )
                else:
                    st.write(
                        "- Maintain a balanced iron intake through natural foods.\n"
                        "- Continue including leafy greens, fruits, and cereals.\n"
                        "- Avoid skipping meals.\n"
                        "- Annual CBC test recommended for general wellness."
                    )

                # --- Visualization: Comparison vs Healthy Range ---
                normal_values = {
                    "Hemoglobin": 13.5 if row.get("Gender", 0) == 0 else 12.0,
                    "MCH": 29,
                    "MCHC": 33,
                    "MCV": 90
                }

                compare_df = pd.DataFrame({
                    "Parameter": list(normal_values.keys()),
                    "Your Value": [row["Hemoglobin"], row["MCH"], row["MCHC"], row["MCV"]],
                    "Healthy Range": list(normal_values.values())
                })

                fig = px.bar(compare_df, x="Parameter", y=["Your Value", "Healthy Range"],
                             barmode="group", color_discrete_sequence=["#ff6666", "#66ccff"],
                             title="ğŸ“Š Your Report vs Healthy Range")
                st.plotly_chart(fig)

            st.info("ğŸ©º Full Anemia Report Generated with Risk Summary, Diet Plan, and Doctor Priority Guidance.")
